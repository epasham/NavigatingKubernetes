###############
# Lab-1:Dynamic nfs provisioner
#################
The NFS provisioner dynamically creates persistent volumes (PVs) and associates them with persistent volume claims (PVC).

Say, If you have an external NFS share and want to use it in a pod or deployment, 
the nfs-subdir-external-provisioner provides a solution for setting up a storage class to 
automate the management of persistent volumes needed for stateful services deployed in kubernetes cluster

# Step-1: setup nfs storage on master
{
apt-get update -y
apt install nfs-kernel-server -y
#apt-get install nfs-common nfs-kernel-server -y
systemctl enable nfs-server
systemctl start nfs-server
systemctl status nfs-server
mkdir -p /mnt/nfs/data
chown nobody:nogroup /mnt/nfs/data
chmod -R 777 /mnt/nfs/data
echo "/mnt/nfs/data *(rw,sync,no_subtree_check,no_root_squash)" >> /etc/exports
exportfs -rav
exportfs -v
showmount -e
}

# Step-2: install nfs client on worker node
ssh root@node01 apt update -y
ssh root@node01 apt install nfs-common -y

# Step 3: Install and Configure NFS Client Provisioner
Deploy NFS Subdir External Provisioner in Kubernetes cluster to automate the creation and management of 
NFS-backed Persistent Volumes (PVs) and Persistent Volume Claims (PVCs)

helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner && helm repo update

# Identify NFS Server IP address
NFSIP=$(ip addr show enp1s0 | awk '$1 == "inet" { print $2 }' | cut -d/ -f1)
echo $NFSIP
172.30.1.2

# Install Helm Chart for NFS Client Provisioner
helm install nfs-subdir-external-provisioner \
nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
--set nfs.server=172.30.1.2 \
--set nfs.path=/mnt/nfs/data \
--set storageClass.onDelete=true

# verify storage class
controlplane:~$ k get sc
NAME                   PROVISIONER                                     RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
nfs-client             cluster.local/nfs-subdir-external-provisioner   Delete          Immediate              true                   31s

# Create pvc
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-pvc
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfs-client
  resources:
    requests:
      storage: 1Gi

# deploy nginx
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx
  name: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: nfs-pvc
      containers:
        - image: nginx
          name: nginx
          volumeMounts:
            - name: data
              mountPath: /usr/share/nginx/html
---
# enter into the pod and create ‘index.html’ file under '/usr/share/nginx/html'
k get po
k exec -it nginx-979465c66-fb64g -- sh
# now we are into pod
# cd /usr/share/nginx/html
# ls -l
# echo "Dynamic NFS Provisioning Demo" > index.html
# cat index.html
Dynamic NFS Provisioning Demo
# exit

# verify the changes are reflecting in the nfs share
cd /mnt/nfs/data
ls -l
cd default-nfs-pvc-pvc-a82b3db3-4da2-47a7-b6a6-3881a5cb1916

controlplane:/mnt/nfs/data/default-nfs-pvc-pvc-a82b3db3-4da2-47a7-b6a6-3881a5cb1916$ cat index.html 
Dynamic NFS Provisioning Demo


##############
# Lab-2:Attach another NFS server storage to the kubernetes cluster
###############
# ssh to worker node or second nfs server and get the IP address
NFSIP=$(ip addr show enp1s0 | awk '$1 == "inet" { print $2 }' | cut -d/ -f1)
echo $NFSIP
172.30.2.2

# Install Helm Chart for NFS ( use different name for release and the storage class )
helm install second-nfs-subdir-external-provisioner \
nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
--set nfs.server=172.30.2.2 \
--set nfs.path=/mnt/nfs/data \
--set storageClass.name=nfs-client-2 \
--set storageClass.provisionerName=k8s-sigs.io/second-nfs-subdir-external-provisioner \
--set storageClass.onDelete=true


# Create pvc
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: nfs-pvc-2
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: nfs-client-2
  resources:
    requests:
      storage: 1Gi

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx
  name: nginx-2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: nfs-pvc-2
      containers:
        - image: nginx
          name: nginx
          volumeMounts:
            - name: data
              mountPath: /usr/share/nginx/html



echo "Dynamic NFS Provisioning using nfs-client-2" > index.html


controlplane:~$ helm ls
NAME                                    NAMESPACE       REVISION        UPDATED                                 STATUS        CHART                                   APP VERSION
nfs-subdir-external-provisioner         default         1               2025-11-28 06:19:27.319233576 +0000 UTC deployed      nfs-subdir-external-provisioner-4.0.18  4.0.2      
second-nfs-subdir-external-provisioner  default         1               2025-11-28 06:53:46.992195611 +0000 UTC deployed      nfs-subdir-external-provisioner-4.0.18  4.0.2      

controlplane:~$ k get po -w
NAME                                                      READY   STATUS    RESTARTS   AGE
nfs-subdir-external-provisioner-7fbfbfd675-2q7cf          1/1     Running   0          37m
nginx-2-76845cd87f-tmjzh                                  1/1     Running   0          4s
nginx-979465c66-fb64g                                     1/1     Running   0          24m
second-nfs-subdir-external-provisioner-685f487b8c-wd4dj   1/1     Running   0          3m9s

controlplane:~$ k exec -it nginx-2-76845cd87f-tmjzh -- sh
# cd /usr/share/nginx/html
# ls
# echo "Dynamic NFS Provisioning using nfs-client-2" > index.html                                                  
# ls
index.html
# cat index.html
Dynamic NFS Provisioning using nfs-client-2

controlplane:~$ ssh node01
Last login: Fri Nov 28 06:49:06 2025 from 10.244.4.229
node01:~$ cd /mnt/nfs/data/
node01:/mnt/nfs/data$ ls -l
total 4
drwxrwxrwx 2 root root 4096 Nov 28 06:58 default-nfs-pvc-2-pvc-517b177d-a673-4a81-8faa-1ff14acef3c5
node01:/mnt/nfs/data$ cd default-nfs-pvc-2-pvc-517b177d-a673-4a81-8faa-1ff14acef3c5/
node01:/mnt/nfs/data/default-nfs-pvc-2-pvc-517b177d-a673-4a81-8faa-1ff14acef3c5$ ls
index.html
node01:/mnt/nfs/data/default-nfs-pvc-2-pvc-517b177d-a673-4a81-8faa-1ff14acef3c5$ cat index.html 
Dynamic NFS Provisioning using nfs-client-2
node01:/mnt/nfs/data/default-nfs-pvc-2-pvc-517b177d-a673-4a81-8faa-1ff14acef3c5$
