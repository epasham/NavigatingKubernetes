############
# Istio
###########
# Download Istio release version
ISTIO_VERSION=1.27.5

# To install latest version
# ISTIO_VERSION="$(curl -sL https://github.com/istio/istio/releases | grep -o 'releases/[0-9]*.[0-9]*.[0-9]*/' | sort -V | \
                  tail -1 | awk -F'/' '{ print $2}')"

TARGET_ARCH=$(uname -m)
curl -L https://istio.io/downloadIstio \
            | ISTIO_VERSION=$ISTIO_VERSION \
              TARGET_ARCH=$TARGET_ARCH sh -
			  
# Add istioctl to the system path
# cd istio-1.27.5/
# ~/istio-1.27.5$ pwd
/root/istio-1.27.5
export PATH=$PWD/bin:$PATH

# list all available built-in Istio profiles
# istioctl profile list
Istio configuration profiles:
    ambient
    default
    demo
    empty
    external
    minimal
    openshift
    preview
    remote
	
# To see full YAML configuration for the specified profile	
# istioctl profile dump <profile-name>
istioctl profile dump default > default-profile.yaml
istioctl profile dump demo > demo-profile.yaml

# Install Istio using the demo profile
# istioctl install --set profile=demo -y
✔ Istio core installed                                                                                                
✔ Istiod installed                                                                                                    
✔ Ingress gateways installed                                                                                          
✔ Egress gateways installed                                                                                           
✔ Installation complete         

# Configure Istio to perform automatic injection of the sidecar proxies to each pod deployed in the default namespace
# k label namespace default istio-injection=enabled

# k get ns default --show-labels
NAME      STATUS   AGE   LABELS
default   Active   20d   istio-injection=enabled,kubernetes.io/metadata.name=default

# Validate that pods in default namespace are automatically injected with an Istio sidecar
kubectl run test --image=nginx

# k get po
NAME   READY   STATUS    RESTARTS   AGE
test   2/2     Running   0          13s

# Verify that the pod has 2 containers:
1 with nginx image named test
1 with the istio proxy named istio-proxy (automatically injected by Istio)

# k get pods -o jsonpath='{range .items[*].spec.containers[*]}{.name}{"\n"}{end}'
test
istio-proxy

# Uninstall Istio from the Kubernetes cluster
istioctl uninstall --purge -y
