# MinIO Initialization Job
# This Job creates the necessary buckets in MinIO for the observability setup
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-init
  labels:
    app: minio-init
spec:
  ttlSecondsAfterFinished: 100
  template:
    metadata:
      labels:
        app: minio-init
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-minio
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          until curl -f http://minio:9000/minio/health/live; do
            echo "Waiting for MinIO to be ready..."
            sleep 5
          done
          echo "MinIO is ready!"
      containers:
      - name: mc
        image: quay.io/minio/mc:latest
        command:
        - sh
        - -c
        - |
          /usr/bin/mc alias set s3 http://minio:9000 admin minio123
          /usr/bin/mc mb s3/loki-data || true
          /usr/bin/mc mb s3/loki-ruler || true
          /usr/bin/mc mb s3/mimir-data || true
          /usr/bin/mc mb s3/mimir-ruler || true
          /usr/bin/mc mb s3/mimir-alerts || true
          /usr/bin/mc mb s3/tempo-traces || true
          /usr/bin/mc ls s3
          echo "[INFO] MinIO buckets created successfully!"
